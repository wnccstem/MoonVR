{% extends "base.html" %}

{% block title %}Sensors - WNCC Aquaponics{% endblock %}

{% block content %}
<div class="container">
    <h1>🪲 Pods In Space Sensor Data Dashboard</h1>
    <p class="lead">Real-time monitoring of the WNCC NASA Pods In Space System</p>

    <!-- Ambient Conditions Card -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="mb-0">🌿 Closed System Ambient Environmental Conditions</h3>
        </div>
        <div class="card-body">
            <div class="row" id="sensor-widgets">
                <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Soil Moisture</h6>
                            <h2 class="display-4 text-dark" id="field4">--</h2>
                            <p class="text-muted small">%</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">CO2 ppm</h6>
                            <h2 class="display-4 text-dark" id="field1">--</h2>
                            <p class="text-muted small">ppm</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Temperature</h6>
                            <h2 class="display-4 text-dark" id="field2">--</h2>
                            <p class="text-muted small">°F</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Temperature</h6>
                            <h2 class="display-4 text-dark" id="field2c">--</h2>
                            <p class="text-muted small">°C</p>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-4 col-md-4 col-sm-6 mb-3">
                    <div class="card text-center bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted">Humidity</h6>
                            <h2 class="display-4 text-dark" id="field3">--</h2>
                            <p class="text-muted small">%</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h3 class="mb-0">🌿 Pod</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <iframe class="chart-iframe" src="https://thingspeak.com/channels/3128979/widgets/1175715"
                                loading="lazy"></iframe>
                        </div>
                        <div class="col-md-6">
                            <iframe class="chart-iframe"
                                src="https://thingspeak.com/channels/3128979/charts/4?dynamic=true&results=60&type=line"
                                loading="lazy"></iframe>
                        </div>

                        <div class="col-md-6">
                            <iframe class="chart-iframe" src="https://thingspeak.com/channels/3128979/widgets/1157434"
                                loading="lazy"></iframe>
                        </div>
                        <div class="col-md-6">
                            <iframe class="chart-iframe"
                                src="https://thingspeak.com/channels/3128979/charts/1?dynamic=true&results=60&type=line"
                                loading="lazy"></iframe>
                        </div>
                        <div class="col-md-6">
                            <iframe class="chart-iframe" src="https://thingspeak.com/channels/3128979/widgets/1157435"
                                loading="lazy"></iframe>
                        </div>
                        <div class="col-md-6">
                            <iframe class="chart-iframe"
                                src="https://thingspeak.com/channels/3128979/charts/2?dynamic=true&results=60&type=line"
                                loading="lazy"></iframe>
                        </div>

                        <div class="col-md-6">
                            <iframe class="chart-iframe" src="https://thingspeak.com/channels/3128979/widgets/1163483"
                                loading="lazy"></iframe>
                        </div>
                        <div class="col-md-6">
                            <iframe class="chart-iframe"
                                src="https://thingspeak.com/channels/3128979/charts/3?dynamic=true&results=60&type=line"
                                loading="lazy"></iframe>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Fetch latest sensor data from Thingspeak API
                async function updateSensorData() {
                    try {
                        const response = await fetch('https://api.thingspeak.com/channels/3128979/feeds/last.json');
                        const data = await response.json();

                        if (data) {
                            // CO2
                            document.getElementById('field1').textContent = data.field1 ? parseFloat(data.field1).toFixed(0) : '--';
                            // Temperature Fahrenheit
                            const tempF = data.field2 ? parseFloat(data.field2) : null;
                            document.getElementById('field2').textContent = tempF !== null ? tempF.toFixed(1) : '--';
                            // Temperature Celsius (convert from F to C)
                            if (tempF !== null) {
                                const tempC = (tempF - 32) * 5 / 9;
                                document.getElementById('field2c').textContent = tempC.toFixed(1);
                            } else {
                                document.getElementById('field2c').textContent = '--';
                            }
                            // Humidity
                            document.getElementById('field3').textContent = data.field3 ? parseFloat(data.field3).toFixed(0) : '--';
                            // Soil Moisture
                            document.getElementById('field4').textContent = data.field4 ? parseFloat(data.field4).toFixed(1) : '--';
                        }
                    } catch (error) {
                        console.error('Error fetching sensor data:', error);
                    }
                }

                // Update on page load and every 30 seconds
                updateSensorData();
                setInterval(updateSensorData, 30000);
            </script>
        </div>
    </div>

    <div class="text-center">
        <a href="{{ url_for('index') }}" class="btn btn-primary">View Live Stream</a>
    </div>

    {% endblock %}