{% extends "base.html" %}

{% block content %}
<div class="container">
  <div class="mb-4">
    <h1 class="mb-2">🪲 Pods In Space - A NASA Martian Regolith Experiment</h1>
    <p>A NASA Closed Ecosystem Experiment by Sarah J Trook. </p>
    <p>The project aims to explore the feasibility of sustaining
      plant life in Martian regolith conditions using a closed
      ecosystem.
    </p>
  </div>

  <!-- Live Camera Stream (Full Width, Natural Height) -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center flex-wrap">
      <h5 class="mb-2 mb-lg-0">🦗 PodCast Live Stream</h5>
      <div class="d-flex gap-2 flex-wrap">
        {% if session.get('user_id') %}
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-light btn-sm" id="recordBtn" title="Start recording stream">
            <i class="bi bi-circle-fill" style="color: red;"></i> Record
          </button>
          <button type="button" class="btn btn-light btn-sm" id="downloadBtn" disabled title="Download recorded video">
            <i class="bi bi-download"></i> Download
          </button>
        </div>
        <div id="recordingTimer" style="display: none; padding: 0.375rem 0.75rem; background-color: #dc3545; color: white; border-radius: 0.25rem; font-weight: bold; font-size: 0.875rem; font-family: monospace;">
          00:00
        </div>
        {% endif %}
        <a href="{{ stream_url }}" target="_blank" class="btn btn-light btn-sm">
          <i class="bi bi-arrows-fullscreen"></i> Full Screen
        </a>
      </div>
    </div>
    <div class="card-body p-0">
      <div id="live-stream-container" style="position: relative; display: inline-block; width: 100%; height: 665px;">
        <div id="live-stream-loading"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: #fff; display: flex; align-items: center; justify-content: center; z-index: 2;">
          <div>
            <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;"></div>
            <div class="mt-3">Loading live stream...</div>
          </div>
        </div>
        <img id="live-stream-img" src="{{ stream_url }}?t={{ timestamp }}" alt="Live Stream"
          data-camera-url="{{ upstream_camera_url }}"
          style="display: block; margin: 0 auto; max-width: 100%; height: 665px; object-fit: contain; z-index: 1; position: relative;"
          onload="document.getElementById('live-stream-loading').style.display='none';">
      </div>
    </div>
  </div>

  {% if latest_sarah_posts and latest_sarah_posts|length > 0 %}
  <div class="mb-4">
    <h3 class="mb-3">Latest Blog Posts from Sarah T</h3>
    <div class="card w-100">
      <div class="card-body p-4">
        {% for post in latest_sarah_posts[:2] %}
        <div class="mb-4">
          <h5 class="card-title">{{ post.title }}</h5>
          <p class="text-muted small">
            <i class="bi bi-person"></i> {{ post.author.username }}
            <i class="bi bi-calendar ms-2"></i> {{ post.created_at.strftime('%B %d, %Y') }}
            <i class="bi bi-eye ms-2"></i> {{ post.view_count }} views
          </p>
          <p class="card-text mb-2">
            {% if post.excerpt %}
            {{ post.excerpt|striptags|truncate(150, True, '...') }}
            {% else %}
            {{ post.content|striptags|truncate(150, True, '...') }}
            {% endif %}
          </p>
          <a href="{{ url_for('blog_bp.view_post', slug=post.slug) }}" class="btn btn-primary">Read More →</a>
        </div>
        {% if not loop.last %}
        <hr class="my-3">
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

{% if session.get('user_id') %}
<script src="{{ url_for('static', filename='js/stream-recorder.js') }}"></script>
{% endif %}

{% endblock %}